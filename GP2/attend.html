<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="CSS/mainStyle.css">
    <link rel="icon" type="image/png" sizes="64x64" href="Images/small-logo-removebg-preview (1).png">
    <title>برنامج وئام - التحضير</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: system-ui, sans-serif;
        }

        body {
            background: #f8f9fa;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .preparation-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 500px;
            padding: 30px;
            text-align: center;
        }

        .preparation-header {
            margin-bottom: 20px;
        }

        .preparation-steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
        }

        .step {
            flex: 1;
            padding: 10px;
            border-bottom: 3px solid #e0e0e0;
            color: #888;
        }

        .step.active {
            border-color: #4C9F9F;
            color: #4C9F9F;
            font-weight: bold;
        }

        .preparation-content {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .location-btn, .qr-btn {
            background: linear-gradient(to right, #4C9F9F, #5FAD5F);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            transition: opacity 0.3s;
        }

        .location-btn:hover, .qr-btn:hover {
            opacity: 0.9;
        }

        .status-message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 6px;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
        }

        .status-warning {
            background: #fff3cd;
            color: #856404;
        }

        .qr-scanner {
            display: none;
            margin-top: 20px;
        }

        #qr-video {
            max-width: 100%;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        #qr-canvas {
            display: none;
        }
    </style>
</head>
<body>
    <div class="preparation-container">
        <div class="preparation-header">
            <h2>التحضير للتطوع</h2>
        </div>

        <div class="preparation-steps">
            <div class="step active" id="step1">الموقع</div>
            <div class="step" id="step2">QR Code</div>
            <div class="step" id="step3">التأكيد</div>
        </div>

        <div class="preparation-content" id="location-section">
            <h3>التحقق من الموقع</h3>
            <p>يجب أن تكون داخل نطاق مكان التطوع لتسجيل الحضور</p>
            <button class="location-btn" id="check-location-btn">التحقق من الموقع</button>
            <div id="location-status" class="status-message"></div>
        </div>

        <div class="preparation-content" id="qr-section" style="display:none;">
            <h3>مسح رمز QR</h3>
            <p>قم بمسح رمز QR الموجود في مكان التطوع</p>
            <div class="qr-scanner" id="qr-scanner">
                <video id="qr-video" playsinline></video>
                <canvas id="qr-canvas"></canvas>
                <button class="qr-btn" id="start-qr-btn">بدء المسح</button>
            </div>
            <div id="qr-status" class="status-message"></div>
        </div>

        <div id="confirmation-modal" class="modal">
            <div class="modal-content">
                <h3>تم التسجيل بنجاح</h3>
                <p>شكراً لك على تسجيل الحضور</p>
                <button class="location-btn" id="close-confirmation">حسناً</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script>
        // عناصر الواجهة
        const checkLocationBtn = document.getElementById('check-location-btn');
        const locationStatus = document.getElementById('location-status');
        const locationSection = document.getElementById('location-section');
        const qrSection = document.getElementById('qr-section');
        const startQRBtn = document.getElementById('start-qr-btn');
        const qrStatus = document.getElementById('qr-status');
        const qrScanner = document.getElementById('qr-scanner');
        const qrVideo = document.getElementById('qr-video');
        const qrCanvas = document.getElementById('qr-canvas');
        const confirmationModal = document.getElementById('confirmation-modal');
        const closeConfirmationBtn = document.getElementById('close-confirmation');

        // خطوات التقدم
        const step1 = document.getElementById('step1');
        const step2 = document.getElementById('step2');
        const step3 = document.getElementById('step3');

        // إعدادات الموقع (المستهدف)
        const targetLat = 24.555472683883004;
        const targetLng = 46.60476370715745;
        const radius = 50; // نصف القطر بالأمتار

        // دالة عرض الرسائل
        function showMessage(element, message, type) {
            element.textContent = message;
            element.className = 'status-message';
            element.classList.add(`status-${type}`);
            element.style.display = 'block';
        }

        // التحقق من الموقع
        function checkLocation() {
            // تسجيل معلومات للتتبع
            console.log("بدء التحقق من الموقع");
            
            // تعطيل الزر أثناء التحقق
            checkLocationBtn.disabled = true;
            showMessage(locationStatus, "جارٍ تحديد موقعك...", "warning");

            // التحقق من دعم تحديد الموقع
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(successCallback, errorCallback, {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                });
            } else {
                showMessage(locationStatus, "المتصفح لا يدعم تحديد الموقع الجغرافي", "error");
                checkLocationBtn.disabled = false;
            }
        }

        // نجاح تحديد الموقع
        function successCallback(position) {
            const userLat = position.coords.latitude;
            const userLng = position.coords.longitude;
            
            console.log(`الموقع الحالي: ${userLat}, ${userLng}`);
            
            // التحقق من النطاق
            if (isWithinRadius(userLat, userLng, targetLat, targetLng, radius)) {
                showMessage(locationStatus, "تم التحقق من موقعك بنجاح!", "success");
                
                // تحديث الواجهة وفتح الكاميرا تلقائياً
                setTimeout(() => {
                    successLocation();
                }, 1000);
            } else {
                // حساب المسافة لعرضها للمستخدم
                const distance = calculateDistance(userLat, userLng, targetLat, targetLng);
                showMessage(locationStatus, 
                    `أنت خارج نطاق التطوع. المسافة: ${distance.toFixed(2)} متر`, 
                    "error"
                );
                checkLocationBtn.disabled = false;
            }
        }

        // فشل تحديد الموقع
        function errorCallback(error) {
            console.error("خطأ في تحديد الموقع:", error);

            let errorMessage = "فشل في تحديد الموقع: ";
            switch (error.code) {
                case error.PERMISSION_DENIED:
                    errorMessage += "يجب السماح بالوصول للموقع";
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMessage += "معلومات الموقع غير متاحة";
                    break;
                case error.TIMEOUT:
                    errorMessage += "انتهت مهلة طلب الموقع";
                    break;
                default:
                    errorMessage += error.message;
            }

            showMessage(locationStatus, errorMessage, "error");
            checkLocationBtn.disabled = false;
        }

        // التحقق من إذا كان المستخدم داخل النطاق
        function isWithinRadius(userLat, userLng, targetLat, targetLng, radius) {
            const distance = calculateDistance(userLat, userLng, targetLat, targetLng);
            return distance <= radius;
        }

        // حساب المسافة بين نقطتين جغرافيتين بالمتر
        function calculateDistance(userLat, userLng, targetLat, targetLng) {
            const earthRadius = 6371000; // نصف قطر الأرض بالمتر
            const dLat = toRadians(targetLat - userLat);
            const dLng = toRadians(targetLng - userLng);
            const lat1 = toRadians(userLat);
            const lat2 = toRadians(targetLat);
            
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                    Math.cos(lat1) * Math.cos(lat2) *
                    Math.sin(dLng / 2) * Math.sin(dLng / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return earthRadius * c;
        }

        // تحويل الدرجات إلى راديان
        function toRadians(degrees) {
            return degrees * (Math.PI / 180);
        }

        // فتح الكاميرا ومسح QR
        function openCamera() {
            qrScanner.style.display = 'block';
            showMessage(qrStatus, "جارٍ تشغيل الكاميرا...", "warning");
            
            console.log("بدء تشغيل الكاميرا");

            navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
                .then(function(stream) {
                    qrVideo.srcObject = stream;
                    qrVideo.setAttribute("playsinline", true);
                    qrVideo.play();
                    
                    const context = qrCanvas.getContext("2d");
                    
                    function scanQRCode() {
                        if (qrVideo.readyState === qrVideo.HAVE_ENOUGH_DATA) {
                            qrCanvas.width = qrVideo.videoWidth;
                            qrCanvas.height = qrVideo.videoHeight;
                            context.drawImage(qrVideo, 0, 0, qrCanvas.width, qrCanvas.height);
                            
                            try {
                                const imageData = context.getImageData(0, 0, qrCanvas.width, qrCanvas.height);
                                const code = jsQR(imageData.data, imageData.width, imageData.height);
                                
                                if (code) {
                                    console.log("تم مسح QR Code:", code.data);
                                    showMessage(qrStatus, "تم مسح رمز QR بنجاح!", "success");
                                    
                                    // إيقاف الكاميرا
                                    stream.getTracks().forEach(track => track.stop());
                                    
                                    // تحديث الواجهة
                                    setTimeout(() => {
                                        step2.classList.remove('active');
                                        step3.classList.add('active');
                                        confirmationModal.style.display = 'flex';
                                    }, 1000);
                                    
                                    return; // إيقاف التكرار
                                }
                            } catch (error) {
                                console.error("خطأ في مسح QR Code:", error);
                            }
                        }
                        
                        // استمرار المسح
                        requestAnimationFrame(scanQRCode);
                    }
                    
                    // بدء عملية المسح
                    scanQRCode();
                })
                .catch(function(error) {
                    console.error("لا يمكن فتح الكاميرا:", error);
                    showMessage(qrStatus, "لا يمكن فتح الكاميرا: " + error.message, "error");
                });
        }

        // إعداد المستمعات
        checkLocationBtn.addEventListener('click', checkLocation);
        startQRBtn.addEventListener('click', openCamera);
        
        // تلقائياً فتح الكاميرا بعد التحقق من الموقع بنجاح
        function successLocation() {
            // تحديث الواجهة
            locationSection.style.display = 'none';
            qrSection.style.display = 'block';
            step1.classList.remove('active');
            step2.classList.add('active');
            
            // فتح الكاميرا مباشرة
            setTimeout(() => {
                openCamera();
            }, 500);
        }
        
        // إغلاق نافذة التأكيد
        closeConfirmationBtn.addEventListener('click', () => {
            confirmationModal.style.display = 'none';
        });
    </script>
</body>
</html>